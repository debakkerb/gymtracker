name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "17"

jobs:
  # ── Backend: Analyze ─────────────────────────────────────────────
  backend-analyze:
    name: Backend · Analyze & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Run analyzer
        run: dart analyze --fatal-infos

  # ── Backend: Build Docker image ──────────────────────────────────
  backend-docker:
    name: Backend · Docker build
    runs-on: ubuntu-latest
    needs: [backend-analyze]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t gymtracker-backend:ci .
        working-directory: backend

  # ── Mobile: Analyze & Lint ───────────────────────────────────────
  mobile-analyze:
    name: Mobile · Analyze & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Run analyzer
        run: flutter analyze --fatal-infos

  # ── Mobile: Tests ────────────────────────────────────────────────
  mobile-test:
    name: Mobile · Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: |
          if [ -d test ]; then
            flutter test --coverage
          else
            echo "No test directory found — skipping"
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: mobile/coverage/lcov.info
          if-no-files-found: ignore

  # ── Mobile: Security audit ───────────────────────────────────────
  mobile-security:
    name: Mobile · Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check for outdated dependencies
        run: flutter pub outdated

      - name: Verify dependency checksums
        run: dart pub deps --json > /dev/null

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Check pubspec.lock is committed
        run: |
          if [ ! -f pubspec.lock ]; then
            echo "::error::pubspec.lock is missing — commit it to pin dependency versions"
            exit 1
          fi

  # ── Mobile: Build Android ────────────────────────────────────────
#  mobile-build-android:
#    name: Mobile · Build Android
#    runs-on: ubuntu-latest
#    needs: [mobile-analyze, mobile-test]
#    defaults:
#      run:
#        working-directory: mobile
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: ${{ env.JAVA_VERSION }}
#
#      - uses: subosito/flutter-action@v2
#        with:
#          channel: stable
#          cache: true
#
#      - name: Install dependencies
#        run: flutter pub get
#
#      - name: Build APK (debug)
#        run: flutter build apk --debug
#
  # ── Mobile: Build iOS ────────────────────────────────────────────
#  mobile-build-ios:
#    name: Mobile · Build iOS
#    runs-on: macos-latest
#    needs: [mobile-analyze, mobile-test]
#    defaults:
#      run:
#        working-directory: mobile
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: subosito/flutter-action@v2
#        with:
#          channel: stable
#          cache: true
#
#      - name: Install dependencies
#        run: flutter pub get
#
#      - name: Build iOS (no codesign)
#        run: flutter build ios --debug --no-codesign
#
  # ── Mobile: Build Web ────────────────────────────────────────────
  mobile-build-web:
    name: Mobile · Build Web
    runs-on: ubuntu-latest
    needs: [mobile-analyze, mobile-test]
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web
